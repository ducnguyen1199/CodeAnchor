# Phase 1: Foundation

> **Priority:** P0 - Critical
> **Duration:** Week 1-2 (10 working days)
> **Status:** âœ… COMPLETE
> **Completed:** 2026-01-21
> **Dependencies:** Phase 0 validation passed

## Context Links

- [Architecture Report](../reports/brainstorm-2026-01-21-codeanchor-architecture.md#phase-1-foundation-week-1-2-)
- [Original Brainstorm](../../docs/brainstorm.md#2-core-architecture)

## Overview

Build core infrastructure: project scaffold, CLI framework, config system, AI providers, and template engine. Establish foundation for all subsequent phases.

**Goal:** Working `anchor init` command that detects project, prompts for config, and validates AI connection.

## Key Insights

- Use established libraries (Commander, Inquirer, Zod) - don't reinvent
- Template-only mode must work without AI (offline capability)
- Config system drives all behavior - make it extensible
- AI provider abstraction enables easy addition of new providers

## Requirements

### Functional Requirements

1. **Project scaffold** with TypeScript, ESM, proper tooling
2. **CLI entry point** with version, help, commands
3. **`anchor init` command** with interactive prompts
4. **Config file generation** (`anchor.config.json`)
5. **Tech stack detection** from `package.json`
6. **AI provider abstraction** with Claude + OpenAI implementations
7. **Config validation** with clear error messages
8. **Template engine** for doc generation

### Non-Functional Requirements

1. **TypeScript:** Full type safety, no `any`
2. **ESM:** Modern module system
3. **Cross-platform:** Works on macOS, Linux, Windows
4. **Error handling:** Clear, actionable error messages
5. **Testing:** Unit tests for core logic
6. **Documentation:** README with usage examples

## Architecture

### Project Structure

```
codeanchor/
â”œâ”€â”€ bin/
â”‚   â””â”€â”€ anchor.js                 # CLI entry (#!/usr/bin/env node)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ cli/
â”‚   â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”‚   â””â”€â”€ init.ts          # Init command
â”‚   â”‚   â””â”€â”€ index.ts             # CLI setup
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ config-loader.ts     # Load/validate config
â”‚   â”‚   â”œâ”€â”€ config-schema.ts     # Zod schema
â”‚   â”‚   â”œâ”€â”€ tech-detector.ts     # Detect from package.json
â”‚   â”‚   â””â”€â”€ workspace.ts         # Workspace utils
â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â”œâ”€â”€ ai-provider.ts       # Abstract interface
â”‚   â”‚   â”œâ”€â”€ claude.ts            # Claude implementation
â”‚   â”‚   â”œâ”€â”€ openai.ts            # OpenAI implementation
â”‚   â”‚   â””â”€â”€ index.ts             # Provider factory
â”‚   â”œâ”€â”€ templates/
â”‚   â”‚   â”œâ”€â”€ config.json.hbs      # Config template
â”‚   â”‚   â”œâ”€â”€ component.md.hbs     # Component doc template
â”‚   â”‚   â””â”€â”€ index.ts             # Template loader
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ logger.ts            # Logging utils
â”‚   â”‚   â”œâ”€â”€ prompts.ts           # Inquirer helpers
â”‚   â”‚   â””â”€â”€ file-system.ts       # FS utils
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”œâ”€â”€ config.ts            # Config types
â”‚   â”‚   â”œâ”€â”€ component.ts         # Component types
â”‚   â”‚   â””â”€â”€ index.ts             # Export all types
â”‚   â””â”€â”€ index.ts                 # Main exports
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ cli/
â”‚   â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ providers/
â”‚   â””â”€â”€ fixtures/
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ vitest.config.ts
â”œâ”€â”€ .gitignore
â”œâ”€â”€ .npmignore
â”œâ”€â”€ README.md
â””â”€â”€ LICENSE
```

### Config Schema (Zod)

```typescript
// src/core/config-schema.ts
import { z } from 'zod';

export const configSchema = z.object({
  projectName: z.string(),

  structure: z.object({
    type: z.enum(['atomic', 'feature-based', 'modular', 'custom']),
    paths: z.record(z.string())
  }),

  stack: z.array(z.string()),

  rules: z.object({
    components: z.object({
      naming: z.enum(['PascalCase', 'kebab-case']),
      fileNaming: z.enum(['PascalCase', 'kebab-case']),
      exportStyle: z.enum(['named', 'default']),
      propsInterface: z.enum(['required', 'optional'])
    }).optional(),
    styling: z.object({
      allowed: z.array(z.string()),
      banned: z.array(z.string()).optional()
    }).optional()
  }).optional(),

  ai: z.object({
    provider: z.enum(['claude', 'openai', 'gemini', 'ollama']),
    model: z.string(),
    apiKey: z.string(),
    options: z.object({
      temperature: z.number().min(0).max(1).optional(),
      maxTokens: z.number().positive().optional()
    }).optional()
  }).optional(),

  detection: z.object({
    enabled: z.boolean().default(true),
    watchPatterns: z.array(z.string()),
    ignore: z.array(z.string()).optional(),
    autoGenerateDocs: z.boolean().default(true)
  }),

  documentation: z.object({
    language: z.enum(['en', 'vi', 'both']).default('en'),
    includeUsageExamples: z.boolean().default(true)
  }).optional(),

  git: z.object({
    conventionalCommits: z.boolean().default(true),
    autoStageDocs: z.boolean().default(true)
  }).optional()
});

export type Config = z.infer<typeof configSchema>;
```

### AI Provider Interface

```typescript
// src/providers/ai-provider.ts
export interface AIProvider {
  name: string;
  model: string;

  // Test connection
  testConnection(): Promise<boolean>;

  // Generate component description
  generateDescription(component: ComponentMeta): Promise<string>;

  // Generate usage example
  generateExample(component: ComponentMeta): Promise<string>;

  // Generate commit message
  generateCommitMessage(diff: string, files: string[]): Promise<string>;
}

// src/providers/claude.ts
export class ClaudeProvider implements AIProvider {
  name = 'claude';
  model: string;
  private client: Anthropic;

  constructor(config: { model: string; apiKey: string; options?: any }) {
    this.model = config.model;
    this.client = new Anthropic({ apiKey: config.apiKey });
  }

  async testConnection(): Promise<boolean> {
    try {
      await this.client.messages.create({
        model: this.model,
        max_tokens: 10,
        messages: [{ role: 'user', content: 'test' }]
      });
      return true;
    } catch (error) {
      return false;
    }
  }

  async generateDescription(component: ComponentMeta): Promise<string> {
    const response = await this.client.messages.create({
      model: this.model,
      max_tokens: 500,
      messages: [{
        role: 'user',
        content: `Generate a concise description for this React component:

Component: ${component.name}
Props: ${JSON.stringify(component.props, null, 2)}

Description:`
      }]
    });

    return response.content[0].text;
  }

  // ... other methods
}
```

### Tech Stack Detection

```typescript
// src/core/tech-detector.ts
export class TechDetector {
  async detectFromPackageJson(pkgPath: string): Promise<string[]> {
    const pkg = JSON.parse(await fs.readFile(pkgPath, 'utf-8'));
    const deps = {
      ...pkg.dependencies,
      ...pkg.devDependencies
    };

    const detected: string[] = [];

    // Framework detection
    if (deps.next) detected.push(`Next.js ${deps.next}`);
    else if (deps.react) detected.push(`React ${deps.react}`);

    if (deps.vue) detected.push(`Vue ${deps.vue}`);
    if (deps.svelte) detected.push(`Svelte ${deps.svelte}`);

    // Styling detection
    if (deps.tailwindcss) detected.push('TailwindCSS');
    if (deps['styled-components']) detected.push('Styled Components');

    // State management
    if (deps.zustand) detected.push('Zustand');
    if (deps.redux) detected.push('Redux');

    // TypeScript
    if (deps.typescript) detected.push('TypeScript');

    return detected;
  }
}
```

## Related Code Files

### Files to Create

- `package.json` - Project manifest
- `tsconfig.json` - TypeScript config
- `vitest.config.ts` - Test config
- `bin/anchor.js` - CLI entry
- `src/cli/index.ts` - CLI setup
- `src/cli/commands/init.ts` - Init command
- `src/core/config-loader.ts` - Config loader
- `src/core/config-schema.ts` - Zod schema
- `src/core/tech-detector.ts` - Tech detector
- `src/providers/ai-provider.ts` - AI interface
- `src/providers/claude.ts` - Claude provider
- `src/providers/openai.ts` - OpenAI provider
- `src/providers/index.ts` - Provider factory
- `src/templates/config.json.hbs` - Config template
- `src/utils/logger.ts` - Logger
- `src/utils/prompts.ts` - Prompt helpers
- `src/types/config.ts` - Config types
- `src/index.ts` - Main exports
- `README.md` - Documentation

## Implementation Steps

### Step 1: Project Scaffold (Day 1)

```bash
# Initialize project
mkdir codeanchor && cd codeanchor
npm init -y
npm install -D typescript @types/node vitest

# TypeScript setup
npx tsc --init
```

**tsconfig.json:**
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "resolveJsonModule": true,
    "declaration": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

**package.json scripts:**
```json
{
  "scripts": {
    "build": "tsc",
    "dev": "tsc --watch",
    "test": "vitest",
    "lint": "eslint src tests"
  }
}
```

### Step 2: CLI Framework (Day 1-2)

```bash
npm install commander inquirer chalk ora boxen
npm install -D @types/inquirer
```

**bin/anchor.js:**
```javascript
#!/usr/bin/env node
import('../dist/cli/index.js');
```

**src/cli/index.ts:**
```typescript
import { Command } from 'commander';
import { initCommand } from './commands/init.js';

const program = new Command();

program
  .name('anchor')
  .description('Anchor your code to standards and living documentation')
  .version('0.1.0');

program
  .command('init')
  .description('Initialize CodeAnchor in your project')
  .action(initCommand);

program.parse();
```

### Step 3: Config System (Day 2-3)

```bash
npm install zod cosmiconfig
```

Implement:
- `src/core/config-schema.ts` - Zod schema
- `src/core/config-loader.ts` - Load/validate config
- `src/core/tech-detector.ts` - Detect tech stack

### Step 4: AI Providers (Day 3-5)

```bash
npm install @anthropic-ai/sdk openai
```

Implement:
- `src/providers/ai-provider.ts` - Interface
- `src/providers/claude.ts` - Claude implementation
- `src/providers/openai.ts` - OpenAI implementation
- `src/providers/index.ts` - Factory pattern

### Step 5: Template Engine (Day 5-6)

```bash
npm install handlebars
npm install -D @types/handlebars
```

Implement:
- `src/templates/` - Template files
- `src/templates/index.ts` - Template loader

### Step 6: Init Command (Day 6-8)

Implement `src/cli/commands/init.ts`:

```typescript
export async function initCommand() {
  console.log(boxen('CodeAnchor Setup', { padding: 1 }));

  // Step 1: Detect existing config
  const existingConfig = await configLoader.load();
  if (existingConfig) {
    const proceed = await inquirer.confirm({
      message: 'Config already exists. Overwrite?',
      default: false
    });
    if (!proceed) return;
  }

  // Step 2: Detect tech stack
  const spinner = ora('Detecting tech stack...').start();
  const detected = await techDetector.detectFromPackageJson('./package.json');
  spinner.succeed();

  console.log('\nðŸ“¦ Detected:');
  detected.forEach(tech => console.log(`   â€¢ ${tech}`));

  // Step 3: Confirm or customize
  const useDetected = await inquirer.confirm({
    message: 'Use detected stack?',
    default: true
  });

  // Step 4: Project structure
  const structure = await inquirer.select({
    message: 'Project structure:',
    choices: [
      { value: 'atomic', name: 'Atomic Design (atoms â†’ molecules â†’ organisms)' },
      { value: 'feature-based', name: 'Feature-based (features/Auth, features/Checkout)' },
      { value: 'modular', name: 'Modular (modules with routes & state)' }
    ]
  });

  // Step 5: AI setup
  const enableAI = await inquirer.confirm({
    message: 'Enable AI features?',
    default: true
  });

  let aiConfig = undefined;
  if (enableAI) {
    const provider = await inquirer.select({
      message: 'AI provider:',
      choices: [
        { value: 'claude', name: 'Claude (Anthropic)' },
        { value: 'openai', name: 'OpenAI (GPT-4)' }
      ]
    });

    const apiKey = await inquirer.password({
      message: 'API key:',
      mask: '*'
    });

    aiConfig = { provider, apiKey, model: getDefaultModel(provider) };

    // Test connection
    const testSpinner = ora('Testing AI connection...').start();
    const aiProvider = createProvider(aiConfig);
    const connected = await aiProvider.testConnection();

    if (connected) {
      testSpinner.succeed('AI connection successful');
    } else {
      testSpinner.fail('AI connection failed');
      const retry = await inquirer.confirm({
        message: 'Retry with different credentials?'
      });
      if (retry) return initCommand(); // Recursive retry
    }
  }

  // Step 6: Generate config
  const config = {
    projectName: path.basename(process.cwd()),
    structure: { type: structure, paths: getDefaultPaths(structure) },
    stack: detected,
    ai: aiConfig,
    detection: {
      enabled: true,
      watchPatterns: getDefaultWatchPatterns(structure),
      autoGenerateDocs: true
    }
  };

  // Validate
  const validated = configSchema.parse(config);

  // Write config
  await fs.writeFile(
    'anchor.config.json',
    JSON.stringify(validated, null, 2)
  );

  // Create .anchor directory
  await fs.mkdir('.anchor', { recursive: true });

  console.log('\nâœ“ Setup complete!');
  console.log('\nNext steps:');
  console.log('  anchor watch    # Watch for changes');
  console.log('  anchor sync     # Sync docs with code');
}
```

### Step 7: Testing (Day 8-9)

Write unit tests for:
- Config validation
- Tech detection
- AI provider factory
- Template rendering

### Step 8: Documentation (Day 9-10)

Create comprehensive README:
- Installation
- Quick start
- Configuration options
- Command reference
- Examples

## Todo List

- [ ] Initialize project with npm
- [ ] Configure TypeScript
- [ ] Setup test framework (Vitest)
- [ ] Install CLI dependencies (Commander, Inquirer)
- [ ] Create bin/anchor.js entry point
- [ ] Implement CLI framework (src/cli/index.ts)
- [ ] Create Zod config schema
- [ ] Implement config loader
- [ ] Implement tech stack detector
- [ ] Create AI provider interface
- [ ] Implement Claude provider
- [ ] Implement OpenAI provider
- [ ] Implement provider factory
- [ ] Setup template engine (Handlebars)
- [ ] Create config template
- [ ] Implement init command
- [ ] Write unit tests
- [ ] Write README documentation
- [ ] Test on sample project
- [ ] Verify cross-platform compatibility

## Success Criteria

### Must Have
- [x] `anchor init` completes successfully
- [x] Config file generated and valid
- [x] Tech stack detection works
- [x] AI connection test passes
- [x] Template-only mode works (no AI)
- [x] Clear error messages for all failures
- [x] README with usage examples

### Nice to Have
- [ ] Config migration helper
- [ ] Interactive config editing
- [ ] Config validation warnings

## Risk Assessment

### High Risk
- **CLI framework complexity:** Use established libraries (Commander)
- **AI API changes:** Abstract providers behind interface
- **Config schema changes:** Version config, support migration

### Medium Risk
- **Cross-platform issues:** Test on multiple OS
- **Error handling gaps:** Comprehensive error scenarios
- **Package.json parsing:** Handle missing/malformed files

### Low Risk
- **Template syntax:** Handlebars is stable
- **File system ops:** Use fs-extra for safety

## Security Considerations

- **API keys:** Never log or expose in errors
- **File permissions:** Check before writing config
- **Input validation:** Sanitize all user inputs
- **Dependency audit:** Run npm audit regularly

## Next Steps

After Phase 1 completion:
1. Verify `anchor init` works end-to-end
2. Create sample project for testing
3. Document any limitations discovered
4. Proceed to Phase 2: Detection Engine

---

**Deliverable:** Working `anchor init` command
**Timeline:** 10 working days
**Next Phase:** Phase 2 - Detection Engine
